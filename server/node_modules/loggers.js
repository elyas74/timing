//
// my logger :)
//
// by : elyas
// create : 29/1/95
// edit : 24/2/95

var fs = require('fs');
var db = require('db');
var path = require('path');
var date_to_persian = require('functions/date_to_persian');


console.original_log = console.log;
console.original_error = console.error;

// export my logger
console.log = log;
console.error = error;
console.info = info;
console.security = security;
console.open = open;
console.very_log = very_log;
console.file_log = _file_log;

// implementing functions
function error(log_string) {
   console.log(log_string, {
      type: "error",
      color: "red"
   });
};

function info(log_string) {
   console.log(log_string, {
      type: "info",
      color: "green"
   });
};

function security(log_string) {
   console.log(log_string, {
      type: "security",
      color: "yellow"
   });
};

function very_log(log_string) {
   console.log(log_string, {
      type: "very_log",
      color: "green"
   });
};


function _file_log(log_string) {
   file_log(log_string + '\n', "routes", true);
};


function log(log_string, option) {

   option = option || {};

   type = option.type || "info";
   color = option.color || "green";

   string_date(function(date_string) {

      date_string += " (" + type + ")" + " -> ";

      // print it
      if (type == "error") {

         // this will log it in stderr
         console.original_error(date_string[color] + log_string);
      } else {

         // this will log it in sdtout
         console.original_log(date_string[color] + log_string);
      }

      // save it to file
      file_log(date_string + log_string + "\n", type);


      // log it in mongodb
      if (global.init.mongo_log) {
         mongo_log(date_string + log_string, type);
      }
   });
};

// console.dir do someting like this
function open(log_string) {

   string_date(function(date_string) {
      date_string += " (open) -> ";
      console.original_log(date_string.blue + JSON.stringify(log_string, null, "    "));
   });
};


function file_log(log, type, just_file) {

   type = type || "info";

   // if I want just to log it in specefic file
   if (!just_file)
      fs.appendFile(path.join(__dirname, "../server-all.log"), log, function(err) {
         if (err) return console.original_error(err);
      });

   fs.appendFile(path.join(__dirname, "../server" + "-" + type + ".log"), log, function(err) {
      if (err) return console.original_error(err);
   });
}

function mongo_log(log_text, type) {

   var log = {
      log: global.init.name + "_v" + global.init.version + " " + log_text
   };

   if (type) {
      log.type = type;
   }

   new db.logs(log).save(function(err) {
      if (err) console.log(err);
   });
}

// generate a string contain date for begining of log
function string_date(cb) {

   cb = cb || function() {};

   date_to_persian(new Date(), function(date) {
      var d = "";
      d += date.date.substring(2) + " " + date.time;
      cb(d);
   });
}
